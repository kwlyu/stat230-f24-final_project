---
title: "Final Project Code"
author: "Rebecca Hazen, Kunwu Lyu, and Jackson Rankin"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = T, error=FALSE, message=FALSE, warning=FALSE)
library(tidyverse)
library(ggplot2)
library(GGally)
library(ggResidpanel)
library(broom)
library(patchwork)
library(purrr)
library(car)
library(corrplot)
library(MASS)
library(plotly)
library(gridExtra)
library(rlang)
```

## Data Wrangling

```{r Reading and Cleaning Data}
happiness_raw <- read_csv("GSS_commute_happiness.csv")

happiness_cleaned <- happiness_raw %>%
  select(year, happy, commute, realrinc, educ, race, gender1) %>% 
  filter(commute != ".i:  Inapplicable",
         realrinc > 0,
         happy != ".n:  No answer") %>% 
  mutate(
    educ = case_when(
      str_detect(educ, "grade") ~ as.numeric(str_extract(educ, "\\d+")),
      str_detect(educ, "college") ~ as.numeric(str_extract(educ, "\\d+")) + 12,
      str_detect(educ, "No formal schooling") ~ 0,
      TRUE ~ NA
    ),
    commute = if_else(str_detect(commute, "\\d+"), 
                      as.numeric(str_extract(commute, "\\d+")), NA),
    race = if_else(race == "White", "White", "Non White"),
    gender = if_else(gender1 == "MALE", "Male", "Female")
  ) %>% 
  select(-gender1)

happiness_recode <- happiness_cleaned %>% 
  mutate(happy = if_else(happy == "Not too happy", 0, 1)) %>% 
  drop_na() 

write.csv(happiness_recode, file = "happiness_recode.csv")
```

## EDA

```{r}
ggpairs(happiness_cleaned)

# Density plot for happiness by commute time
ggplot(happiness_cleaned, aes(x = happy, y = commute, fill = happy)) +
  geom_boxplot() +
  labs(title = "Commute Time Distribution by Happiness Level", 
       x = "Commute Time (minutes)", 
       fill = "Happiness Level")

# Boxplot of income by happiness level
ggplot(happiness_cleaned, aes(x = happy, y = realrinc, fill = happy)) +
  geom_boxplot() +
  labs(title = "Income Distribution by Happiness Level", 
       x = "Happiness Level", 
       y = "Real Income",
       fill = "Happiness Level")

# Bar plot of happiness level by education level
ggplot(happiness_cleaned, aes(x = educ, fill = happy)) +
  geom_bar(position = "fill") +
  labs(title = "Proportion of Happiness Levels by Education Level", 
       x = "Education Level", 
       y = "Proportion",
       fill = "Happiness Level") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Faceted bar plot for happiness levels by race and gender
ggplot(happiness_cleaned, aes(x = gender, fill = happy)) +
  geom_bar(position = "fill") +
  facet_wrap(~ race) +
  labs(title = "Proportion of Happiness by Race and Gender", 
       x = "Gender", 
       y = "Proportion",
       fill = "Happiness Level")
```

```{r}
# Boxplot for happiness by commute time
plot1 <- ggplot(happiness_cleaned, aes(x = happy, y = commute, fill = happy)) +
  geom_boxplot() +
  labs(title = "Commute Time Distribution by Happiness Level",  
       x = "Commute Time (minutes)", 
       fill = "Happiness Level")

# Boxplot of income by happiness level
plot2 <- ggplot(happiness_cleaned, aes(x = happy, y = realrinc, fill = happy)) +
  geom_boxplot() +
  labs(title = "Income Distribution by Happiness Level", 
       x = "Happiness Level", 
       y = "Real Income", 
       fill = "Happiness Level")

# Bar plot of happiness level by education level
plot3 <- ggplot(happiness_cleaned, aes(x = educ, fill = happy)) +
  geom_bar(position = "fill") +
  labs(title = "Proportion of Happiness Levels by Education Level", 
       x = "Education Level", 
       y = "Proportion", 
       fill = "Happiness Level") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Faceted bar plot for happiness levels by race and gender
plot4 <- ggplot(happiness_cleaned, aes(x = gender, fill = happy)) +
  geom_bar(position = "fill") +
  facet_wrap(~ race) +
  labs(title = "Proportion of Happiness by Race and Gender", 
       x = "Gender", 
       y = "Proportion", 
       fill = "Happiness Level")

# Arrange all plots in a 2x2 grid
grid.arrange(plot1, plot2, plot3, plot4, ncol = 2)
```


## Logistic Regression

```{r}
happiness_glm <- glm(happy ~ commute + realrinc + educ + race + gender, 
                     data = happiness_recode, family = binomial)

summary(happiness_glm)
vif(happiness_glm)
happiness_aug1 <- augment(happiness_glm, data=happiness_recode,
                          type.residuals="pearson")

happiness_aug1$C_grps <- ntile(happiness_recode$commute, n = 20)
happiness_resid1 <- happiness_aug1 %>%
  group_by(C_grps) %>%
  summarize(C_grps_median = median(C_grps), # median D of groups
            resid_mean = mean(.resid)) # mean residual

ggplot(happiness_resid1, aes(x = C_grps_median, y = resid_mean)) + 
  geom_point() + 
  geom_hline(yintercept = 0)

happiness_aug1$Y_grps <- ntile(happiness_recode$realrinc, n = 20)
happiness_resid2 <- happiness_aug1 %>%
  group_by(Y_grps) %>%
  summarize(Y_grps_median = median(Y_grps), # median D of groups
            resid_mean = mean(.resid)) # mean residual

ggplot(happiness_resid2, aes(x = Y_grps_median, y = resid_mean)) + 
  geom_point() + 
  geom_hline(yintercept = 0)
```

```{r}
empirical_plot_fn <- function(quant_var, cat_var, scale = "lin") {
  # Convert strings to symbols
  quant_group <- rlang::sym(quant_var)
  cat_group <- rlang::sym(cat_var)
  
  happiness_ag <- happiness_recode %>% 
    group_by(!!quant_group, !!cat_group) %>% 
    summarize(
      p = sum(happy == 1) / n(), # Proportion happy
      log_odds = log(p / (1 - p)), # Avoid log issues
      .groups = "drop" # Avoid warning about grouping
    )
  
  # Add a column for x_var based on the scale
  happiness_ag <- happiness_ag %>%
    mutate(x_var = if (scale == "log") log(!!quant_group) else !!quant_group)
  
  # Set the x-axis label
  x_lab <- str_c(if (scale == "log") "Log of " else "", quant_var)
  
  # Plot using precomputed x_var
  ggplot(happiness_ag, 
         aes(x = x_var, y = log_odds, color = !!cat_group)) + 
    geom_point() +
    labs(x = x_lab, y = "Empirical Log Odds")
}


# Iterate over all different combinations
# vars to iterate over
quant_vars <- c("commute", "realrinc", "educ")
cat_vars <- c("gender", "race")
# init empty list to store
empirical_log_odds_plot <- list()
for (quant_var in quant_vars) {
  for (cat_var in cat_vars) {
    # Generate the plot and store it in the list
    plot_name <- paste(quant_var, cat_var, sep = "_")
    empirical_log_odds_plot[[plot_name]] <- empirical_plot_fn(quant_var = quant_var, cat_var = cat_var)
  }
}
empirical_log_odds_plot
ggplot(happiness_recode, aes(x = commute, y = happy, color = gender)) +
  geom_jitter(width = 0.2, height = 0.2, alpha = 0.3) +
  labs(y = "Happy", x = "Commute Time", color = "Gender") +
  scale_y_continuous(breaks = c(0, 1))
ggplot(happiness_recode, aes(x = realrinc, y = happy, color = gender)) +
  geom_jitter(width = 0.2, height = 0.2, alpha = 0.3) +
  labs(y = "Happy", x = "Real Income", color = "Gender") +
  scale_y_continuous(breaks = c(0, 1))
ggplot(happiness_recode, aes(x = educ, y = happy, color = gender)) +
  geom_jitter(width = 0.2, height = 0.2, alpha = 0.3) +
  labs(y = "Happy", x = "Education", color = "Gender") +
  scale_y_continuous(breaks = c(0, 1))
  #Notes (by Jackson for Interaction Reference)
    #Concern for interaction between commute and gender
      #Concern for interaction between education and gender
```

##### Becca's section


```{r}
#3# test
```


### Jackson's Section

```{r}
#EDA implies need to log both commute time and income level to reduce skew
  #Remove 0 values
happiness_glm_refit<-
  glm(happy ~ log(commute+1) + log(realrinc+1) + educ + race +gender,
                         data=happiness_recode, family=binomial)
summary(happiness_glm_refit)
vif(happiness_glm_refit) #Looks good, suprisingly no problem with educ and Y

#Refit model with interaction terms inspired from EDA
happiness_glm_gender<-
  glm(happy ~ log(commute+1)*gender + log(realrinc+1) + educ*gender + race, 
                          data=happiness_recode, family=binomial)
summary(happiness_glm_gender)
  #Interaction Terms appear weak

#Test for Interaction Term Significance
anova(happiness_glm_refit, happiness_glm_gender)
  #Inclusion of interaction terms has no statistically discernible impact
    #on model explanatory power

#Augment regression and prepare binning for residual plots
happiness_aug<-augment(happiness_glm_refit, resid.type="pearson")
  #Commute
happiness_aug$CommuteGroups<-ntile(happiness_aug$`log(commute + 1)`, n=75)
happiness_aug_resid1<- happiness_aug %>%
  group_by(CommuteGroups) %>%
    summarize(CommuteGroupsMed = median(`log(commute + 1)`),
              resid_mean=mean(.resid), resid_med=median(.resid))
  #Education
happiness_aug$EducGroups<-ntile(happiness_aug$educ, n=75)
happiness_aug_resid2<- happiness_aug %>%
  group_by(EducGroups) %>%
    summarize(EducGroupsMed = median(educ),
              resid_mean=mean(.resid), resid_med=median(.resid))
  #Income
happiness_aug$YGroups<-ntile(happiness_aug$`log(realrinc + 1)`, n=75)
happiness_aug_resid3<- happiness_aug %>%
  group_by(YGroups) %>%
    summarize(YGroupsMed = median(`log(realrinc + 1)`),
              resid_mean=mean(.resid), resid_med=median(.resid))

#Assumption Checking: Residual Plots
  #Commute Time
ggplot(data=happiness_aug_resid1, aes(x=CommuteGroups, y=resid_mean))+
  geom_point()+
  geom_hline(yintercept=c(-2, 0, 2), linetype="dotted")+
  labs(x="Grouped Commute Times (minutes)", y="Mean Pearson Residual", 
       title="Residual Plot of Grouped Commute Time")
  #Education
ggplot(data=happiness_aug_resid2, aes(x=EducGroups, y=resid_mean))+
  geom_point()+
  geom_hline(yintercept=c(-2, 0, 2), linetype="dotted")+
  labs(x="Grouped Education levels", y="Mean Pearson Residual", 
       title="Residual Plot of Grouped Education Level")
  #Income
ggplot(data=happiness_aug_resid3, aes(x=YGroups, y=resid_mean))+
  geom_point()+
  geom_hline(yintercept=c(-2, 0, 2), linetype="dotted")+
  labs(x="Grouped Annual Income Levels (1986 dollars)", 
       y="Mean Pearson Residual", 
       title="Residual Plot of Grouped Income Level")
  #Across all plots general concern about possible outliers skew, 
    #Also very slight possible downward trend in Income plot

#Analysis of Case Influence Statistics
happiness_aug <- happiness_aug %>% mutate(case = row_number())

  #Check Cook's Distances
ggplot(happiness_aug, aes(x=case, y=.cooksd))+
  geom_point()+
  labs(x="Index", y="Cook's Distance", 
       title="Cooks Distances for Model")
  #No apparently concerning values, all far below 1

  #Examine Studentized Residuals
ggplot(happiness_aug, aes(x=case, y=.std.resid))+
  geom_point()+
  geom_hline(yintercept=c(-3,3), linetype="dotted", color="red")+
  labs(x="Index", y="Studentized Residual", 
  title="Studentized Residuals for Original Model")
    #How to deal with this? Groups like previous?-->seems odd b/c looking for outliers

#Examine Leverage
ggplot(happiness_aug, aes(x=case, y=.hat))+
  geom_point()+
  geom_hline(yintercept=6/874, linetype="dotted", color="red")+
  labs(x="Index", y="Leverage", title="Leverage for Original Model")
    #No particularly apparent outliers although many points above flagging range
```

